<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/widgets/pluginControls.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/ajboni/calvo" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-jack_client.html">jack_client</a><ul class='methods'><li data-type='method'><a href="module-jack_client.html#~clearPluginPorts">clearPluginPorts</a></li><li data-type='method'><a href="module-jack_client.html#~connectPlugins">connectPlugins</a></li><li data-type='method'><a href="module-jack_client.html#~connectPorts">connectPorts</a></li><li data-type='method'><a href="module-jack_client.html#~disconnectPlugins">disconnectPlugins</a></li><li data-type='method'><a href="module-jack_client.html#~getAvailableJackPorts">getAvailableJackPorts</a></li><li data-type='method'><a href="module-jack_client.html#~init">init</a></li><li data-type='method'><a href="module-jack_client.html#~poll">poll</a></li><li data-type='method'><a href="module-jack_client.html#~queryJack">queryJack</a></li><li data-type='method'><a href="module-jack_client.html#~queryTransport">queryTransport</a></li></ul></li><li><a href="module-jalv.html">jalv</a><ul class='methods'><li data-type='method'><a href="module-jalv.html#~getControls">getControls</a></li><li data-type='method'><a href="module-jalv.html#~jalvStdoutToJSON">jalvStdoutToJSON</a></li><li data-type='method'><a href="module-jalv.html#~kill_plugin">kill_plugin</a></li><li data-type='method'><a href="module-jalv.html#~spawn_plugin">spawn_plugin</a></li><li data-type='method'><a href="module-jalv.html#~write">write</a></li></ul></li><li><a href="module-keyboard.html">keyboard</a><ul class='methods'><li data-type='method'><a href="module-keyboard.html#~registerKeyboardShortcuts">registerKeyboardShortcuts</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#~focusNext">focusNext</a></li><li data-type='method'><a href="module-layout.html#~focusPrev">focusPrev</a></li><li data-type='method'><a href="module-layout.html#~renderScreen">renderScreen</a></li><li data-type='method'><a href="module-layout.html#~setUpLayout">setUpLayout</a></li></ul></li><li><a href="module-lv2.html">lv2</a><ul class='methods'><li data-type='method'><a href="module-lv2.html#~buildPluginCache">buildPluginCache</a></li><li data-type='method'><a href="module-lv2.html#~getPluginByName">getPluginByName</a></li><li data-type='method'><a href="module-lv2.html#~grep">grep</a></li><li data-type='method'><a href="module-lv2.html#~init">init</a></li><li data-type='method'><a href="module-lv2.html#~pluginInfo">pluginInfo</a></li></ul></li><li><a href="module-settings.html">settings</a></li><li><a href="module-store.html">store</a><ul class='methods'><li data-type='method'><a href="module-store.html#~addPluginToRack">addPluginToRack</a></li><li data-type='method'><a href="module-store.html#~clearRack">clearRack</a></li><li data-type='method'><a href="module-store.html#~connectAll">connectAll</a></li><li data-type='method'><a href="module-store.html#~connectLastToMasterOutputs">connectLastToMasterOutputs</a></li><li data-type='method'><a href="module-store.html#~connectPlugins">connectPlugins</a></li><li data-type='method'><a href="module-store.html#~disconnectAll">disconnectAll</a></li><li data-type='method'><a href="module-store.html#~getJackStatus">getJackStatus</a></li><li data-type='method'><a href="module-store.html#~moveRackItem">moveRackItem</a></li><li data-type='method'><a href="module-store.html#~notifySubscribers">notifySubscribers</a></li><li data-type='method'><a href="module-store.html#~processConnections">processConnections</a></li><li data-type='method'><a href="module-store.html#~reconectAll">reconectAll</a></li><li data-type='method'><a href="module-store.html#~removePluginAt">removePluginAt</a></li><li data-type='method'><a href="module-store.html#~setAudioSource">setAudioSource</a></li><li data-type='method'><a href="module-store.html#~setAudioSourceMode">setAudioSourceMode</a></li><li data-type='method'><a href="module-store.html#~setCurrentPage">setCurrentPage</a></li><li data-type='method'><a href="module-store.html#~setJackStatus">setJackStatus</a></li><li data-type='method'><a href="module-store.html#~setSelectedPluginIndex">setSelectedPluginIndex</a></li><li data-type='method'><a href="module-store.html#~wlog">wlog</a></li><li data-type='method'><a href="module-store.html#~wlogError">wlogError</a></li></ul></li><li><a href="module-string_utils.html">string_utils</a><ul class='methods'><li data-type='method'><a href="module-string_utils.html#~removeNewLines">removeNewLines</a></li><li data-type='method'><a href="module-string_utils.html#~safe">safe</a></li><li data-type='method'><a href="module-string_utils.html#~stringToTrimmedArray">stringToTrimmedArray</a></li></ul></li><li><a href="module-widgets.html">widgets</a><ul class='methods'><li data-type='method'><a href="module-widgets.html#~IOWidgetaudioIO">IOWidget</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#getControlValueLabel">getControlValueLabel</a></li><li><a href="global.html#getControlValuePercent">getControlValuePercent</a></li><li><a href="global.html#parseControlValue">parseControlValue</a></li><li><a href="global.html#progressControl">progressControl</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/widgets/pluginControls.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Jalv = require("../jalv");
const blessed = require("blessed");
const contrib = require("blessed-contrib");
const PubSub = require("pubsub-js");
const Layout = require("../layout");
const store = require("../store");
const { settings } = require("../../settings");

const PluginControls = function (grid, x, y, xSpan, ySpan) {
  const pluginControls = grid.set(y, x, ySpan, xSpan, blessed.box, {
    label: "Plugin Parameters",
    input: true,
    mouse: true,
    interactive: true,
    keys: true,
    padding: { left: 1, right: 1 },
    style: {
      focus: {
        border: { fg: "red" },
        //   enabled: false,
      },
    },
  });

  const plugin = store.getSelectedPlugin();

  var token = PubSub.subscribe("selectedPlugin", update);

  // TODO: subscribe to "JALV controls" and sync sliders. (need to store the controls somewhere to set data instead of redraw.)
  // Actually, set control returns the control modified. If we store controls by its symbol, we can update only our modified control, much faster.
  // Maybe store a reference to the widget in plugin.info ?
  async function update(msg, plugin) {
    pluginControls.children.forEach((ctrl) => {
      ctrl.hide;
      Layout.renderScreen();
    });

    if (!plugin) return;

    // Store the control widget on the plugin instance:
    if (!plugin.info.controlWidgets) plugin.info.controlWidgets = {};

    const values = await Jalv.getControls(plugin, "controls");

    let y = 0;
    plugin.ports.control.input.forEach((control) => {
      y += 2;

      if (!plugin.info.controlWidgets[control.symbol]) {
        controlWidget = progressControl(
          values[control.symbol],
          y,
          control,
          plugin
        );
        pluginControls.append(controlWidget);
        plugin.info.controlWidgets[control.symbol] = controlWidget;
      } else {
        // FIXME
        // plugin.info.controlWidgets[control.symbol].setContent(
        //   values[control.symbol]
        // );
      }
    });
  }

  return pluginControls;
};

/**
 *  Initializes a plugin control widget.
 *   // {
  // 	"comment": null,
  // 	"designation": null,
  // 	"index": 6,
  // 	"name": "Master level",
  // 	"properties": [],
  // 	"rangeSteps": null,
  // 	"ranges": { "default": 0.0, "maximum": 30.0, "minimum": -30.0 },
  // 	"scalePoints": [],
  // 	"shortName": "Master level",
  // 	"symbol": "master",
  // 	"units": { "label": "decibels", "render": "%f dB", "symbol": "dB" }
  //   },
 *
 * @param {number} value 
 * @param {number} top
 * @param {pluginControl} pluginControl 
 * @param {pluginInstance} pluginInstance
 * @returns
 */
function progressControl(value, top, pluginControl, pluginInstance) {
  const {
    comment,
    designation,
    index,
    name,
    properties,
    rangeSteps,
    ranges,
    scalePoints,
    shortName,
    symbol,
    units,
  } = pluginControl;

  var box = blessed.box({
    interactive: false,
    focusable: false,
    top: top,
  });

  box.value = parseControlValue(pluginControl, value);
  const valuePercent = getControlValuePercent(pluginControl, box.value);

  //    Control Label
  var label = blessed.text({
    content: shortName,
    left: 1,
    top: 1,
    interactive: false,
    focusable: false,
  });

  //    Progress Widget
  var progress = blessed.progressbar({
    border: {
      type: "line",
      fg: "#512725",
    },
    style: {
      focus: {
        border: {
          fg: "#637373",
        },
        bar: {
          fg: "#5faf5f",
        },
      },
    },
    input: true,
    ch: "â–‘",
    height: 3,
    top: 0,
    left: "35%",
    right: "8",
    filled: parseInt(valuePercent.toString()),
    width: "65%",
  });

  const valueLabelValue = getControlValueLabel(
    pluginControl,
    box.value.toFixed(2)
  );

  var valueLabel = blessed.text({
    content: valueLabelValue,
    right: 4,
    top: 1,
    interactive: false,
    focusable: false,
  });

  box.append(label);
  box.append(progress);
  box.append(valueLabel);

  box.updateValue = async function (val) {
    const result = await Jalv.setControl(pluginInstance, pluginControl, val);
    const newValue = parseControlValue(pluginControl, val);

    box.value = newValue;
    const _valuePercent = getControlValuePercent(pluginControl, newValue);
    const _valueLabel = getControlValueLabel(
      pluginControl,
      newValue.toFixed(2)
    );
    progress.setProgress(_valuePercent);
    valueLabel.setContent(_valueLabel);
    store.wlogDebug(JSON.stringify(result));
  };

  //   Keyboard action
  progress.key(
    [
      "right",
      "C-right",
      "S-right",
      "left",
      "C-left",
      "S-left",
      "pageup",
      "pagedown",
    ],
    function (e, keys) {
      let newValue = 0;

      // if it is a toggle button, just send 0 or 1
      if (properties.includes("toggled")) {
        if (keys.name === "right") {
          newValue = 1;
        }
      } else {
        let step = settings.DEFAULT_CONTROL_STEP;

        // For small values, (less than 1, make the steps even smaller)
        if (ranges.maximum - ranges.minimum &lt; 1) {
          step = (ranges.maximum - ranges.minimum) / 10;
        }

        // For big values make bigger steps.
        // Need to test if could affect a 'sensible' knob that for example would blast the volume up.
        if (ranges.maximum - ranges.minimum > 100) {
          step = (ranges.maximum - ranges.minimum) / 10;
        }

        // TODO: Not working properly
        if (properties.includes("logarithmic")) {
          // This value indicates into how many evenly-divided points the (control) port range should be divided for step-wise control. This may be used for changing the value with step-based controllers like arrow keys, mouse wheel, rotary encoders, and so on.
          // Note that when used with a logarithmic port, the steps are logarithmic too, and port value can be calculated as:
          // value = lower * pow(upper / lower, step / (steps - 1))
          // and the step from value is:
          //   // step = (steps - 1) * log(value / lower) / log(upper / lower)
          //   step =
          //     (9 * Math.log(box.value / ranges.minimum)) /
          //     Math.log(ranges.maximum / ranges.minimum);
          //   store.wlogDebug("Log Scale");
        }

        if (keys.shift) step /= 10;
        if (keys.ctrl) step *= 5;
        if (keys.name === "pageup") step = -ranges.maximum / 5;
        if (keys.name === "pagedown") step = ranges.maximum / 5;
        if (keys.name === "left") step = -step;
        newValue = box.value + step;

        if (ranges) {
          if (newValue &lt; ranges.minimum) newValue = ranges.minimum;
          if (newValue > ranges.maximum) newValue = ranges.maximum;
        }
      }
      box.updateValue(newValue);
    }
  );

  //   progress.key(["home", "end"], function (e, key) {
  //     if (key.name === "home") Layout.focusPrev();
  //     else if (key.name === "end") Layout.focusNext();
  //   });

  progress.key(["up", "down"], function (e, key) {
    if (key.name === "up") Layout.focusPrev();
    else if (key.name === "down") Layout.focusNext();
  });

  //   progress.key("S-right", function (a, b) {
  //     box.updateValue(box.value + settings.DEFAULT_CONTROL_MEDIUM_STEP);
  //   });

  //   progress.key("left", function (a, b) {
  //     box.updateValue(box.value - settings.DEFAULT_CONTROL_SMALL_STEP);
  //   });

  //   progress.key("S-right", function (a, b) {
  //     box.updateValue(box.value + settings.DEFAULT_CONTROL_MEDIUM_STEP);
  //   });

  return box;
}

/**
 * Returns a relative percent of a value for a plugin control.
 * Uses rangeMax and RangeMin
 *
 * @param {puglinControl} control plugin control.
 * @param {number} value Value to calculate %
 */
function getControlValuePercent(control, value) {
  const parsedValue = control.properties.includes("integer")
    ? parseInt(value)
    : parseFloat(value);
  const valuePercent =
    // (parsedValue / (control.ranges.minimum + control.ranges.maximum)) * 100;
    ((parsedValue - control.ranges.minimum) /
      (control.ranges.maximum - control.ranges.minimum)) *
    100;

  return valuePercent;
}

/**
 * Creates a label for a specific control.
 *
 * @param {*} control Plugin control
 * @param {*} value Value to append to the label
 * @returns Returns a label with units if applicable and formatted according to the LV2 specification.
 */
function getControlValueLabel(control, value) {
  let valueLabelValue = value;
  const parsedValue = parseControlValue(control, value);
  if (Object.keys(control.units).length > 0) {
    valueLabelValue = control.units.render.replace("%f", valueLabelValue);
  }
  ///"units": { "label": "decibels", "render": "%f dB", "symbol": "dB" }
  if (control.properties.includes("toggled")) {
    valueLabelValue = parsedValue === 1 ? "ON" : "OFF";
  }

  return valueLabelValue;
}

/**
 * Parse a control value, usually a float except if defined in properties.
 * TODO: Check other cases.
 *
 * @param {plugin control} control
 * @param {string} value
 * @returns a float or an int with the value
 */
function parseControlValue(control, value) {
  const parsedValue = control.properties.includes("integer")
    ? parseInt(value)
    : parseFloat(value);
  return parsedValue;
}

module.exports = PluginControls;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Fri Jul 24 2020 21:12:44 GMT-0300 (Argentina Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <link type="text/css" rel="stylesheet" href="./docs-style.css">
    
</body>
</html>
