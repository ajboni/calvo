<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/widgets/pluginMonitor.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/ajboni/calvo" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-jack_client.html">jack_client</a><ul class='methods'><li data-type='method'><a href="module-jack_client.html#~clearPluginPorts">clearPluginPorts</a></li><li data-type='method'><a href="module-jack_client.html#~connectPlugins">connectPlugins</a></li><li data-type='method'><a href="module-jack_client.html#~connectPorts">connectPorts</a></li><li data-type='method'><a href="module-jack_client.html#~disconnectPlugins">disconnectPlugins</a></li><li data-type='method'><a href="module-jack_client.html#~getAvailableJackPorts">getAvailableJackPorts</a></li><li data-type='method'><a href="module-jack_client.html#~init">init</a></li><li data-type='method'><a href="module-jack_client.html#~poll">poll</a></li><li data-type='method'><a href="module-jack_client.html#~queryJack">queryJack</a></li><li data-type='method'><a href="module-jack_client.html#~queryTransport">queryTransport</a></li></ul></li><li><a href="module-jalv.html">jalv</a><ul class='methods'><li data-type='method'><a href="module-jalv.html#~addToQueue">addToQueue</a></li><li data-type='method'><a href="module-jalv.html#~getControls">getControls</a></li><li data-type='method'><a href="module-jalv.html#~jalvStdoutToJSON">jalvStdoutToJSON</a></li><li data-type='method'><a href="module-jalv.html#~kill_plugin">kill_plugin</a></li><li data-type='method'><a href="module-jalv.html#~processQueue">processQueue</a></li><li data-type='method'><a href="module-jalv.html#~setControl">setControl</a></li><li data-type='method'><a href="module-jalv.html#~spawn_plugin">spawn_plugin</a></li><li data-type='method'><a href="module-jalv.html#~write">write</a></li><li data-type='method'><a href="module-jalv.html#~writeWait">writeWait</a></li></ul></li><li><a href="module-keyboard.html">keyboard</a><ul class='methods'><li data-type='method'><a href="module-keyboard.html#~registerKeyboardShortcuts">registerKeyboardShortcuts</a></li></ul></li><li><a href="module-layout.html">layout</a><ul class='methods'><li data-type='method'><a href="module-layout.html#~focusNext">focusNext</a></li><li data-type='method'><a href="module-layout.html#~focusPrev">focusPrev</a></li><li data-type='method'><a href="module-layout.html#~renderScreen">renderScreen</a></li><li data-type='method'><a href="module-layout.html#~setUpLayout">setUpLayout</a></li></ul></li><li><a href="module-lv2.html">lv2</a><ul class='methods'><li data-type='method'><a href="module-lv2.html#~buildPluginCache">buildPluginCache</a></li><li data-type='method'><a href="module-lv2.html#~getPluginByName">getPluginByName</a></li><li data-type='method'><a href="module-lv2.html#~grep">grep</a></li><li data-type='method'><a href="module-lv2.html#~init">init</a></li><li data-type='method'><a href="module-lv2.html#~pluginInfo">pluginInfo</a></li></ul></li><li><a href="module-settings.html">settings</a></li><li><a href="module-store.html">store</a><ul class='methods'><li data-type='method'><a href="module-store.html#~addPluginToRack">addPluginToRack</a></li><li data-type='method'><a href="module-store.html#~clearRack">clearRack</a></li><li data-type='method'><a href="module-store.html#~connectAll">connectAll</a></li><li data-type='method'><a href="module-store.html#~connectLastToMasterOutputs">connectLastToMasterOutputs</a></li><li data-type='method'><a href="module-store.html#~connectPlugins">connectPlugins</a></li><li data-type='method'><a href="module-store.html#~disconnectAll">disconnectAll</a></li><li data-type='method'><a href="module-store.html#~getJackStatus">getJackStatus</a></li><li data-type='method'><a href="module-store.html#~moveRackItem">moveRackItem</a></li><li data-type='method'><a href="module-store.html#~notifySubscribers">notifySubscribers</a></li><li data-type='method'><a href="module-store.html#~processConnections">processConnections</a></li><li data-type='method'><a href="module-store.html#~reconectAll">reconectAll</a></li><li data-type='method'><a href="module-store.html#~removePluginAt">removePluginAt</a></li><li data-type='method'><a href="module-store.html#~setAudioSource">setAudioSource</a></li><li data-type='method'><a href="module-store.html#~setAudioSourceMode">setAudioSourceMode</a></li><li data-type='method'><a href="module-store.html#~setCurrentPage">setCurrentPage</a></li><li data-type='method'><a href="module-store.html#~setJackStatus">setJackStatus</a></li><li data-type='method'><a href="module-store.html#~setSelectedPluginIndex">setSelectedPluginIndex</a></li><li data-type='method'><a href="module-store.html#~wlog">wlog</a></li><li data-type='method'><a href="module-store.html#~wlogError">wlogError</a></li></ul></li><li><a href="module-string_utils.html">string_utils</a><ul class='methods'><li data-type='method'><a href="module-string_utils.html#~removeNewLines">removeNewLines</a></li><li data-type='method'><a href="module-string_utils.html#~safe">safe</a></li><li data-type='method'><a href="module-string_utils.html#~stringToTrimmedArray">stringToTrimmedArray</a></li></ul></li><li><a href="module-widgets.html">widgets</a><ul class='methods'><li data-type='method'><a href="module-widgets.html#~IOWidgetaudioIO">IOWidget</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#getControlValueLabel">getControlValueLabel</a></li><li><a href="global.html#getControlValuePercent">getControlValuePercent</a></li><li><a href="global.html#parseControlValue">parseControlValue</a></li><li><a href="global.html#PluginMonitor">PluginMonitor</a></li><li><a href="global.html#progressControl">progressControl</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/widgets/pluginMonitor.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Jalv = require("../jalv");
const blessed = require("blessed");
const contrib = require("blessed-contrib");
const PubSub = require("pubsub-js");
const Layout = require("../layout");
const store = require("../store");
const { settings } = require("../../settings");
const {
  getControlValueLabel,
  getControlValuePercent,
  parseControlValue,
} = require("./pluginControls");

/** Monitors the output for the selected plugin **/
const PluginMonitor = function (grid, x, y, xSpan, ySpan) {
  const pluginMonitor = grid.set(y, x, ySpan, xSpan, blessed.box, {
    label: "Plugin Monitor",
    input: false,
    interactive: false,
    keys: false,
    padding: { left: 1, right: 1 },
    mouse: true,
    scrollable: true,

    style: {
      scrollbar: true,
      focus: {
        border: { fg: "red" },
        //   enabled: false,
      },
    },
  });

  const plugin = store.getSelectedPlugin();
  var token = PubSub.subscribe("selectedPlugin", update);

  //  Update all controls for a given plugin
  async function update(msg, plugin) {
    const length = JSON.parse(JSON.stringify(pluginMonitor.children.length));
    for (let index = length - 1; index > 0; index--) {
      const element = pluginMonitor.children[index];
      element.hide();
    }

    if (!plugin) return;

    if (plugin.ports.control.output.length === 0) {
      pluginMonitor.append(
        blessed.text({ content: "No monitor ports on selected plugin." })
      );
    }

    // Store the control widget on the plugin instance:
    if (!plugin.info.monitorWidgets) plugin.info.monitorWidgets = {};

    let y = 0;
    plugin.ports.control.output.forEach((control) => {
      if (!plugin.info.monitorWidgets[control.symbol]) {
        monitorWidget = progressControl(0, y, control, plugin);
        pluginMonitor.append(monitorWidget);
        plugin.info.monitorWidgets[control.symbol] = monitorWidget;
      } else {
        plugin.info.monitorWidgets[control.symbol].show();
      }
      y += 2;
    });
  }

  PubSub.subscribe("pluginMonitorsChanged", updateValues);
  async function updateValues(msg, plugin) {
    if (!plugin) return;
    const values = plugin.info.monitors;

    plugin.ports.control.output.forEach((control) => {
      if (values[control.symbol]) {
        plugin.info.monitorWidgets[control.symbol].setValue(
          values[control.symbol]
        );
      }

      plugin.info.monitorWidgets[control.symbol].show();
    });

    // store.wlogDebug(JSON.stringify(values));
  }
  return pluginMonitor;
};

/**
 *  Initializes a plugin control widget.
 *
 * @param {number} value focused
 * @param {number} top
 * @param {pluginControl} pluginControl
 * @param {pluginInstance} pluginInstance
 * @returns Returns the progress control blessed widget.
 */
function progressControl(value, top, pluginControl, pluginInstance) {
  const {
    comment,
    designation,
    index,
    name,
    properties,
    rangeSteps,
    ranges,
    scalePoints,
    shortName,
    symbol,
    units,
  } = pluginControl;

  var box = blessed.box({
    interactive: false,
    focusable: false,
    top: top,
  });

  box.value = parseControlValue(pluginControl, value);
  const valuePercent = getControlValuePercent(pluginControl, box.value);

  //    Control Label
  var label = blessed.text({
    content: shortName,
    left: 1,
    top: 1,
    interactive: false,
    focusable: false,
  });

  //    Progress Widget
  var progress = blessed.progressbar({
    interactive: false,
    focusable: false,
    keyable: false,
    keys: false,
    border: {
      type: "bg",
      //   fg: "#882822",
      //   bg: "#512725",
    },
    style: {
      bg: "#282828",
      focus: {
        bg: "#1e1e1e",
        border: {
          fg: "#637373",
        },
        bar: {
          bg: "#68955d",
        },
      },
    },
    input: true,
    ch: "░",
    height: 3,
    top: 0,
    left: "35%",
    right: "8",
    filled: parseInt(valuePercent.toString()),
    width: "65%",
  });

  const valueLabelValue = getControlValueLabel(
    pluginControl,
    box.value.toFixed(2)
  );

  var valueLabel = blessed.text({
    content: valueLabelValue,
    right: 4,
    top: 1,
    interactive: false,
    focusable: false,
  });

  box.append(label);
  box.append(progress);
  box.append(valueLabel);

  box.updateValue = function (val) {
    Jalv.setControl(pluginInstance, pluginControl, val);
    const newValue = parseControlValue(pluginControl, val);

    box.value = newValue;
    const _valuePercent = getControlValuePercent(pluginControl, newValue);
    const _valueLabel = getControlValueLabel(
      pluginControl,
      newValue.toFixed(2)
    );
    progress.setProgress(_valuePercent);
    valueLabel.setContent(_valueLabel);
  };

  box.setValue = function (val) {
    const newValue = parseControlValue(pluginControl, val);

    box.value = newValue;
    const _valuePercent = getControlValuePercent(pluginControl, newValue);
    const _valueLabel = getControlValueLabel(
      pluginControl,
      newValue.toFixed(2)
    );
    progress.setProgress(_valuePercent);
    valueLabel.setContent(_valueLabel);
  };

  return box;
}

module.exports = PluginMonitor;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Mon Jul 27 2020 01:58:07 GMT-0300 (Argentina Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



    <link type="text/css" rel="stylesheet" href="./docs-style.css">
    
</body>
</html>
